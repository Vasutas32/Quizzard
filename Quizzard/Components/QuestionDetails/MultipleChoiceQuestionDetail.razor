@using Quizzard.Models
@using Quizzard.Models.Questions

@for (int i = 0; i < question.AnswerOptions.Count; i++)
{
	var index = i;
	<label style="margin-bottom: 10px;">
		<input type="checkbox"
			   checked="@IsChecked(question.Id, question.AnswerOptions[index])"
			   @onchange="(ChangeEventArgs e) => OnMultipleChoiceChange(question.Id, question.AnswerOptions[index], e)" />
		@question.AnswerOptions[index].OptionText
	</label>
	<br />
}

@code {

	[Parameter]
	public MultipleChoiceQuestion question { get; set; }

	[Parameter]
	public UserAnswer userAnswer { get; set; }

	[Parameter]
	public List<UserAnswer> userAnswers { get; set; }

	//Dictionary key is the question id
	//Value is a list of selected answer option indices
	private Dictionary<int, List<int>> multipleChoiceSelections = new Dictionary<int, List<int>>();

	private bool IsChecked(int questionId, AnswerOption option)
	{
		return multipleChoiceSelections.TryGetValue(questionId, out var selections) && selections.Contains(option.OrderIndex);
	}

	private void OnMultipleChoiceChange(int questionId, AnswerOption option, ChangeEventArgs e)
	{
		var isChecked = e.Value?.ToString()?.ToLower() == "true";

		var ua = userAnswers.FirstOrDefault(a => a.QuestionId == questionId);
		if (ua != null)
		{
			if (!multipleChoiceSelections.ContainsKey(questionId))
			{
				multipleChoiceSelections[questionId] = new List<int>();
			}
			var selections = multipleChoiceSelections[questionId];
			if (isChecked)
			{
				if (!selections.Contains(option.OrderIndex))
					selections.Add(option.OrderIndex);
			}
			else
			{
				selections.Remove(option.OrderIndex);
			}
			ua.SelectedAnswer = string.Join(";", selections.OrderBy(x => x));
		}
	}
}
