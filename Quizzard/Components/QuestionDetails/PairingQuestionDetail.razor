@using Quizzard.Models
@using Quizzard.Models.Questions

<div style="display:flex; gap:2rem;">
	<!-- Column A -->
	<div>
		<h5>Column A</h5>
		@for (int i = 0; i < pq.ColumnA.Count; i++)
		{
			var index = i;
			var orderIndex = pq.AnswerOptions[index].OrderIndex;
			var bg = pairs.ContainsKey(orderIndex)
			? ColorForPair(orderIndex)
			: (selectedAIndex == orderIndex ? "#e0e0e0" : "white");
			<button class="btn" style="margin:0.2rem; background:@bg;"
			@onclick="() => OnClickA(orderIndex)">
				@pq.ColumnA[index]
			</button>
		}
	</div>
	<!-- Column B -->
	<div>
		<h5>Column B</h5>
		@for (int j = 0; j < pq.ColumnB.Count; j++)
		{
			var index = j;
			var orderIndex = pq.AnswerOptions[index + pq.ColumnA.Count].OrderIndex;
			var pairedA = pairs.FirstOrDefault(kv => kv.Value == orderIndex).Key;
			string bg = "white";
			if (TryGetPairedA(orderIndex, out var aIndex))
			{
				bg = ColorForPair(aIndex);
			}
			else if (selectedBIndex == orderIndex)
			{
				bg = "#e0e0e0";
			}
			<button class="btn" style="margin:0.2rem; background:@bg;"
					@onclick="() => OnClickB(orderIndex)">
				@pq.ColumnB[index]
			</button>
		}
	</div>
</div>

@code {

	[Parameter]
	public PairingQuestion pq { get; set; }

	[Parameter]
	public UserAnswer userAnswer { get; set; }


	private Dictionary<int, int> pairs = new Dictionary<int, int>();

	private int? selectedAIndex;

	private int? selectedBIndex;

	private static readonly string[] palette = new[]
	{
		"#FF0000", "#BAE1FF", "#B4DA55", "#FFFFBA", "#E2BAFF", "#FFDAC1"
	};


	private Dictionary<int, string> pairColors = new Dictionary<int, string>();

	private int nextColorSlot = 0;


	void OnClickA(int aIndex)
	{
		// toggle‐off if clicked twice
		if (selectedAIndex == aIndex)
		{
			selectedAIndex = null;
			return;
		}
		selectedAIndex = aIndex;

		// if B had already a selection, commit the pair
		if (selectedBIndex.HasValue)
		{
			FormPair(aIndex, selectedBIndex.Value);
		}
	}

	void OnClickB(int bIndex)
	{
		// toggle‐off if clicked twice
		if (selectedBIndex == bIndex)
		{
			selectedBIndex = null;
			return;
		}
		selectedBIndex = bIndex;

		// if A had already a selection, commit the pair
		if (selectedAIndex.HasValue)
		{
			FormPair(selectedAIndex.Value, bIndex);
		}
	}

	private void FormPair(int aIndex, int bIndex)
	{
		// remove any existing pairing that pointed to this bi:
		if (TryGetPairedA(bIndex, out var oldAIndex))
		{
			pairs.Remove(oldAIndex);
			pairColors.Remove(oldAIndex);
		}

		// add the new pairing and assign it a fresh color
		pairs[aIndex] = bIndex;

		EnsureHasColor(aIndex);

		// clear temporary selections
		selectedAIndex = null;
		selectedBIndex = null;

		UpdateUserAnswer();
	}

	private void EnsureHasColor(int aIndex)
	{
		if (!pairColors.ContainsKey(aIndex))
		{
			var color = nextColorSlot < palette.Length
						? palette[nextColorSlot]
						: $"hsl({nextColorSlot * 60 % 360},70%,80%)";

			pairColors[aIndex] = color;
			nextColorSlot++;
		}
	}


	private bool TryGetPairedA(int bIndex, out int aIndex)
	{
		foreach (var kv in pairs)
		{
			if (kv.Value == bIndex)
			{
				aIndex = kv.Key;
				return true;
			}
		}
		aIndex = -1;
		return false;
	}

	string ColorForPair(int aIndex)
	{
		return pairColors.TryGetValue(aIndex, out var color) ? color : "transparent";
	}

	void UpdateUserAnswer()
	{
		// flatten dictionary ai→bi into "ai bi; ai bi; ..." form, sorted by ai
		var entries = pairs.OrderBy(kv => kv.Key)
								.Select(kv => $"{kv.Key}:{kv.Value}");

		userAnswer.SelectedAnswer = string.Join(";", entries);
	}
}
