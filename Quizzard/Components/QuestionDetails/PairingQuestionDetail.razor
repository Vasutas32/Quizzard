@using Quizzard.Models
@using Quizzard.Models.Questions

<div style="display:flex; gap:2rem;">
	<!-- Column A -->
	<div>
		<h5>Column A</h5>
		@for (int i = 0; i < pq.ColumnA.Count; i++)
		{
			var index = i;
			var bg = pairs[question.Id].ContainsKey(pq.AnswerOptions[index].ClientId.ToString())
			? ColorForPair(question.Id, pq.AnswerOptions[index].ClientId.ToString())
			: "white";
			<button class="btn" style="margin:0.2rem; background:@bg;"
					@onclick="() => OnClickA(question.Id, pq.AnswerOptions[index].ClientId.ToString())">
				@pq.ColumnA[index]
			</button>
		}
	</div>
	<!-- Column B -->
	<div>
		<h5>Column B</h5>
		@for (int j = 0; j < pq.ColumnB.Count; j++)
		{
			var index = j;
			var pairedA = pairs[question.Id]
			.FirstOrDefault(kv => kv.Value == pq.AnswerOptions[index + pq.ColumnA.Count].ClientId.ToString()).Key;
			string bg = "white";
			if (TryGetPairedA(question.Id, pq.AnswerOptions[index + pq.ColumnA.Count].ClientId.ToString(), out var aClientId))
			{
				bg = ColorForPair(question.Id, aClientId);
			}
			<button class="btn" style="margin:0.2rem; background:@bg;"
					@onclick="() => OnClickB(question.Id, pq.AnswerOptions[index + pq.ColumnA.Count].ClientId.ToString())">
				@pq.ColumnB[index]
			</button>
		}
	</div>
</div>

@code {

	[Parameter]
	public PairingQuestion pq { get; set; }
	[Parameter]
	public Question question { get; set; }

	[Parameter]
	public List<UserAnswer> userAnswers { get; set; }


	[Parameter]
	public Dictionary<int, Dictionary<string, string>> pairs { get; set; }
	[Parameter]
	public Dictionary<int, string?> selectedA { get; set; }
	[Parameter]
	public Dictionary<int, string?> selectedB { get; set; }

	private static readonly string[] PairColors = new[]
		{
	"#FF0000", "#BAE1FF", "#B4DA55", "#FFFFBA", "#E2BAFF", "#FFDAC1"
  };

	[Parameter]
	public Dictionary<int, Dictionary<string, string>> _pairColors { get; set; }

	private Dictionary<int, int> _nextPairColorIndex = new();


	void OnClickA(int qid, string aClientId)
	{
		// toggle‐off if clicked twice
		if (selectedA[qid] == aClientId)
		{
			selectedA[qid] = null;
			return;
		}
		selectedA[qid] = aClientId;

		// if B had already a selection, commit the pair
		if (selectedB[qid] != null)
		{
			var bClientId = selectedB[qid];

			// remove any existing pairing that pointed to this bi:
			if (TryGetPairedA(qid, bClientId, out var oldAClientId))
			{
				pairs[qid].Remove(oldAClientId);
				_pairColors[qid].Remove(oldAClientId);
			}

			// add the new pairing and assign it a fresh color
			pairs[qid][aClientId] = bClientId;
			EnsureHasColor(qid, aClientId);

			// clear temporary selections
			selectedA[qid] = selectedB[qid] = null;
			UpdateUserAnswer(qid);
		}
	}

	void OnClickB(int qid, string bClientId)
	{
		// toggle‐off if clicked twice
		if (selectedB[qid] == bClientId)
		{
			selectedB[qid] = null;
			return;
		}
		selectedB[qid] = bClientId;

		// if A had already a selection, commit the pair
		if (selectedA[qid] != null)
		{
			var aClientId = selectedA[qid];

			// remove any existing pairing that pointed to this bi:
			if (TryGetPairedA(qid, bClientId, out var oldAClientId))
			{
				pairs[qid].Remove(oldAClientId);
				_pairColors[qid].Remove(oldAClientId);
			}

			// add the new pairing and assign it a fresh color
			pairs[qid][aClientId] = bClientId;
			EnsureHasColor(qid, aClientId);

			// clear temporary selections
			selectedA[qid] = selectedB[qid] = null;
			UpdateUserAnswer(qid);
		}
	}



	private void EnsureHasColor(int qid, string aClientId)
	{
		if (!_pairColors.TryGetValue(qid, out var map))
			_pairColors[qid] = map = new Dictionary<string, string>();

		if (!_nextPairColorIndex.TryGetValue(qid, out var next))
			_nextPairColorIndex[qid] = next = 0;

		if (!map.ContainsKey(aClientId))
		{
			// grab the slot, *then* increment
			var slot = next;
			_nextPairColorIndex[qid] = next + 1;

			// pick the color
			var color = slot < PairColors.Length
						? PairColors[slot]
						: $"hsl({slot * 60 % 360},70%,80%)";

			map[aClientId] = color;
		}
	}


	private bool TryGetPairedA(int qid, string bClientId, out string aClientId)
	{
		foreach (var kv in pairs[qid])
		{
			if (kv.Value == bClientId)
			{
				aClientId = kv.Key;
				return true;
			}
		}
		aClientId = "";
		return false;
	}

	string ColorForPair(int qid, string aClientId)
	{
		if (_pairColors.TryGetValue(qid, out var map) &&
			map.TryGetValue(aClientId, out var bClientId))
			return bClientId;
		return "transparent";
	}

	void UpdateUserAnswer(int qid)
	{
		// flatten dictionary ai→bi into "ai bi; ai bi; ..." form, sorted by ai
		var dict = pairs[qid];
		var entries = dict.OrderBy(kv => kv.Key)
								.Select(kv => $"{kv.Key}:{kv.Value}");

		userAnswers.First(a => a.QuestionId == qid)
							.SelectedAnswer = string.Join(";", entries);
	}
}
