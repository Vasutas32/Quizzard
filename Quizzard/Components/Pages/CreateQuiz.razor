@page "/create-quiz"
@rendermode InteractiveServer
@inject Quizzard.Services.QuizService QuizService
@inject IWebHostEnvironment Env
@using Quizzard.Models
@using Quizzard.Models.Questions
@using Microsoft.AspNetCore.Components

<h3>Create a New Quiz</h3>

<!-- Quiz Title Input -->
<input @bind="quizTitle" placeholder="Enter quiz title" />

<!-- Question Type Selector -->
<div>
    <label>Select Question Type:</label>
    <select @bind="selectedQuestionType">
        @foreach (QuestionType type in Enum.GetValues(typeof(QuestionType)))
        {
            <option value="@type">@type</option>
        }
    </select>
</div>

<!-- Add Question Section -->
<h4>Add Questions</h4>
@foreach (var question in questions)
{
    <div>
        <input @bind="question.Text" placeholder="Question text" />
        <br />

        @switch (question){
            case SingleChoiceQuestion scq:
                @for (int i = 0; i < scq.AnswerOptions.Count; i++)
                {
                    var index = i;
                    <input @bind="scq.AnswerOptions[index].OptionText"
                    placeholder=@($"Option {index + 1}") />
                }
                <br />
                <button @onclick="() => AddOption(scq)">+</button>
                <button @onclick="() => RemoveOption(scq)" disabled="@(question.AnswerOptions.Count <= 2)">–</button>
                <br />
                <label>Correct Answer:</label>
                <select @onchange="(e) => scq.CorrectAnswer = e.Value.ToString()">
                    @for (int i = 0; i < scq.AnswerOptions.Count; i++)
                    {
                        <option value="@i">Option @(i + 1)</option>
                    }
                </select>
                break;
            case MultipleChoiceQuestion mcq:
                <!-- Render dynamic answer options for Multiple Choice -->
                @for (int i = 0; i < mcq.AnswerOptions.Count; i++)
                {
                    var index = i;
                    <!-- capture index locally -->
                    <input @bind="mcq.AnswerOptions[index].OptionText"
                    placeholder=@($"Option {index + 1}") />
                }
                <br />
                <button @onclick="() => AddOption(mcq)">+</button>
                <button @onclick="() => RemoveOption(mcq)" disabled="@(mcq.AnswerOptions.Count <= 2)">–</button>
                <br />
                <label>Correct Answers (semicolon separated indices):</label>
                <!-- For multiple choice, creator enters something like "0;3" -->
                <input @bind="mcq.CorrectAnswer" placeholder="e.g., 0;3" />
                break;
            case TrueFalseQuestion tfq:
                <!-- For True/False, the options are fixed; show a message and a dropdown -->
                <p>This is a True/False question. Options are fixed: True and False.</p>
                <label>Correct Answer:</label>
                <select @onchange="(e) => question.CorrectAnswer = e.Value.ToString()">
                    <!-- Use "1" for True and "0" for False -->
                    <option value="1">True</option>
                    <option value="0">False</option>
                </select>

                break;
            case TextInputQuestion tiq:
                <label>Correct Answers (semicolon separated):</label>
                <input @bind="question.CorrectAnswer" placeholder="e.g., cat;feline" />
                break;
            case PairingQuestion pq:
                <p>Pairing:</p>
                @for (int row = 0; row < pq.ColumnA.Count; row++)
                {
                    var index = row;
                    <div style="display:flex; gap:8px; margin-bottom:4px;">
                        <input @bind="pq.ColumnA[index]" placeholder=@($"A{index+1}") />
                        <input @bind="pq.ColumnB[index]" placeholder=@($"B{index+1}") />
                    </div>
                }
                <button @onclick="() => AddPairRow(pq)">+ Row</button>
                <button @onclick="() => RemovePairRow(pq)" disabled="@(pq.ColumnA.Count <= 2)">– Row</button>
                <br />
                <label>Correct Pairs:</label>
                <input @bind="pq.CorrectAnswer" placeholder="e.g. 02;13;20;31" />
                break;
            default:
                break;
        }
        <InputFile OnChange="e => OnImageSelected(question, e)" />
        @if (!string.IsNullOrEmpty(question.ImagePath))
        {
            <img src="@question.ImagePath" alt="Preview" style="max-width:200px;display:block;margin-top:.5em" />
        }
        <button @onclick="() => RemoveQuestion(question)">Remove</button>
        <hr />
    </div>
}

<button @onclick="AddQuestion">Add Question</button>
<button @onclick="SaveQuiz">Save Quiz</button>
<button @onclick="Cancel">Cancel</button>
<button @onclick="Bello">Do the Bello!</button>

@code {
    private string quizTitle = "";
    private List<Question> questions = new();
    private QuestionType selectedQuestionType = QuestionType.SingleChoice;

    // [Inject] private IWebHostEnvironment Env { get; set; }


    private void Bello()
    {
        Console.WriteLine("I'm doing the bello!!");
    }

    private void AddQuestion()
    {
        switch (selectedQuestionType)
        {
            case QuestionType.SingleChoice:
                var newSingleChoiceQuestion = new SingleChoiceQuestion
                    {
                        AnswerOptions = new List<AnswerOption>
                {
                    new AnswerOption { OptionText = "" },
                    new AnswerOption { OptionText = "" }
                },
                    // Default: correct answer is the first option (as a string "0")
                        CorrectAnswer = "0"
                    };
                questions.Add(newSingleChoiceQuestion);
                break;
            case QuestionType.MultipleChoice:
                var newMultipleChoiceQuestion = new MultipleChoiceQuestion
                    {
                        AnswerOptions = new List<AnswerOption>
                {
                    new AnswerOption { OptionText = "" },
                    new AnswerOption { OptionText = "" }
                },
                    // Default: no correct answers initially
                        CorrectAnswer = ""
                    };
                questions.Add(newMultipleChoiceQuestion);
                break;
            case QuestionType.TrueFalse:
                var newTrueFalseQuestion = new TrueFalseQuestion
                    {
                    // For True/False, auto-create fixed answer options:
                        AnswerOptions = new List<AnswerOption>
                {
                    new AnswerOption { OptionText = "True" },
                    new AnswerOption { OptionText = "False" }
                },
                    // Default correct answer is "1" (True)
                        CorrectAnswer = "1"
                    };
                questions.Add(newTrueFalseQuestion);
                break;
            case QuestionType.TextInput:
                var newTextInputQuestion = new TextInputQuestion
                    {
                        CorrectAnswer = "", // Can be multiple acceptable answers separated by semicolons
                    };
                questions.Add(newTextInputQuestion);
                break;
            case QuestionType.Pairing:

                // start with 2 rows = 4 options
                var newPairingQuestion = new PairingQuestion{CorrectAnswer = ""};
                newPairingQuestion.ColumnA = new List<string> { "", "" };
                newPairingQuestion.ColumnB = new List<string> { "", "" };
                newPairingQuestion.SyncAnswerOptionsFromColumns();
                questions.Add(newPairingQuestion);
            break;
            default: 
                break;
        }
        Console.WriteLine("^q^\n");
    }

    void AddPairRow(PairingQuestion pq)
    {
        // add one more A and one more B
        pq.ColumnA.Add("");
        pq.ColumnB.Add("");
        pq.SyncAnswerOptionsFromColumns();
    }

    void RemovePairRow(PairingQuestion pq)
    {
        // remove the last two
        if (pq.ColumnA.Count > 2)
        {
            pq.ColumnA.RemoveAt(pq.ColumnA.Count - 1);
            pq.ColumnB.RemoveAt(pq.ColumnB.Count - 1);
        }
        pq.SyncAnswerOptionsFromColumns();
    }


    private void RemoveQuestion(Question question)
    {
        questions.Remove(question);
    }

    private void AddOption(Question question)
    {
        // Only allow dynamic options for SingleChoice and MultipleChoice
        if (question is SingleChoiceQuestion || question is MultipleChoiceQuestion)
            question.AnswerOptions.Add(new AnswerOption { OptionText = "" });
    }

    private void RemoveOption(Question question)
    {
        if ((question is SingleChoiceQuestion || question is MultipleChoiceQuestion) && question.AnswerOptions.Count > 2)
            question.AnswerOptions.RemoveAt(question.AnswerOptions.Count - 1);
    }

    private async Task SaveQuiz()
    {
        foreach (var pq in questions.OfType<PairingQuestion>())
        {
            pq.SyncAnswerOptionsFromColumns();
        }
        if (!string.IsNullOrWhiteSpace(quizTitle) && questions.Count > 0)
        {
            var newQuiz = new Quiz { Title = quizTitle, Questions = questions };
            await QuizService.AddQuizAsync(newQuiz);
            Navigation.NavigateTo("/");
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/quizzes");
    }

    async Task OnImageSelected(Question question, InputFileChangeEventArgs e)
    {
        var file = e.File;
        // generate a unique name
        var ext = Path.GetExtension(file.Name);
        var fileName = $"{Guid.NewGuid()}{ext}";
        var saveDir = Path.Combine(Env.WebRootPath, "uploads");
        Directory.CreateDirectory(saveDir);
        var savePath = Path.Combine(saveDir, fileName);

        // actually copy
        await using var fs = File.OpenWrite(savePath);
        await file.OpenReadStream(maxAllowedSize: 10_000_000).CopyToAsync(fs);

        // save the *relative* path back into your model
        question.ImagePath = $"uploads/{fileName}";
    }


    [Inject] private NavigationManager Navigation { get; set; }
}
