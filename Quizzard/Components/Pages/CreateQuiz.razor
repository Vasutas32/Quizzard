@page "/create-quiz"
@rendermode InteractiveServer
@inject Quizzard.Services.QuizService QuizService
@inject IWebHostEnvironment Env
@using Quizzard.Models
@using Quizzard.Models.Questions
@using Microsoft.AspNetCore.Components

<h3>Create a New Quiz</h3>

<!-- Quiz Title Input -->
<input @bind="quizTitle" placeholder="Enter quiz title" />

<!-- Question Type Selector -->
<div>
    <label>Select Question Type:</label>
    <select @bind="selectedQuestionType">
        @foreach (QuestionType type in Enum.GetValues(typeof(QuestionType)))
        {
            <option value="@type">@type</option>
        }
    </select>
</div>

<!-- Add Question Section -->
<h4>Add Questions</h4>
@foreach (var question in questions)
{
    <div>
        <input @bind="question.Text" placeholder="Question text" />
        <br />

        <!-- Depending on what the question type is render the question differently-->
        @switch (question){

            case SingleChoiceQuestion scq:
                @for (int i = 0; i < scq.AnswerOptions.Count; i++)
                {
                    var index = i;
                    <input @bind="scq.AnswerOptions[index].OptionText"
                    placeholder=@($"Option {index + 1}") />
                }
                <br />
                <button @onclick="() => AddOption(scq)">+</button>
                <button @onclick="() => RemoveOption(scq)" disabled="@(question.AnswerOptions.Count <= 2)">–</button>
                <br />
                <label>Correct Answer:</label>
                <select @onchange="(e) => scq.CorrectAnswer = e.Value.ToString()">
                    @for (int i = 0; i < scq.AnswerOptions.Count; i++)
                    {
                        <option value="@i">Option @(i + 1)</option>
                    }
                </select>
                break;

            case MultipleChoiceQuestion mcq:
                @for (int i = 0; i < mcq.AnswerOptions.Count; i++)
                {
                    var index = i;
                    <input @bind="mcq.AnswerOptions[index].OptionText"
                    placeholder=@($"Option {index + 1}") />
                }
                <br />
                <button @onclick="() => AddOption(mcq)">+</button>
                <button @onclick="() => RemoveOption(mcq)" disabled="@(mcq.AnswerOptions.Count <= 2)">–</button>
                <br />
                <label>Mark the correct options:</label>
                @for (int i = 0; i < mcq.AnswerOptions.Count; i++)
                {
                    <br />
                    var index = i;
                    <label>
                        <input type="checkbox"
                        checked="@mcq.CorrectAnswerIndices.Contains(index)"
                        @onchange="(ChangeEventArgs e) => OnCorrectOptionChange(mcq, index, e)" />
                        @mcq.AnswerOptions[index].OptionText
                    </label>
                }
                break;

            case TrueFalseQuestion tfq:
                <p>This is a True/False question. Options are fixed: True and False.</p>
                <label>Correct Answer:</label>
                <select @onchange="(e) => question.CorrectAnswer = e.Value.ToString()">
                    <option value="1">True</option>
                    <option value="0">False</option>
                </select>
                break;

            case TextInputQuestion tiq:
                <label>Correct Answers (semicolon separated):</label>
                <input @bind="question.CorrectAnswer" placeholder="e.g., cat;feline" />
                break;

            case PairingQuestion pq:
                var aCount = pq.ColumnA.Count;
                var bCount = pq.ColumnB.Count;
                var pairs = pq.CorrectPairs;
                @for (int row = 0; row < pq.ColumnA.Count; row++)
                {
                    var index = row;
                    <div style="display:flex; gap:8px; margin-bottom:4px;">
                        <input @bind="pq.ColumnA[index]" placeholder=@($"A{index+1}") />
                        <input @bind="pq.ColumnB[index]" placeholder=@($"B{index+1}") />
                    </div>
                }
                <button @onclick="() => AddPairRow(pq)">+ Row</button>
                <button @onclick="() => RemovePairRow(pq)" disabled="@(pq.ColumnA.Count <= 2)">– Row</button>
                <br />
                @*  <label>Correct Pairs:</label>
                <input @bind="pq.CorrectAnswer" placeholder="e.g. 02;13;20;31" /> *@
                <label class="mt-3">Set the correct match for each “A”:</label>

                @for (int a = 0; a < aCount; a++)
                {
                    // scrap the inline lambda & string parsing in-markup...
                    // instead capture the selected B value into a local:
                    var index = a;
                    var selectedB = pairs.TryGetValue(index, out var b) ? b : -1;
                    <div class="d-flex align-items-center mb-2">
                        <strong class="me-2">@pq.ColumnA[index] ↔</strong>
                        <select class="form-select w-auto"
                        value="@selectedB"
                        @onchange="@(e => OnPairSelectionChanged(pq, index, int.Parse(e.Value?.ToString() ?? "-1")) )">
                            <option value="-1">(choose…)</option>
                            @for (int beck = 0; beck < bCount; beck++)
                            {
								var indexB = beck;
                                <option value="@indexB">@pq.ColumnB[indexB]</option>
                            }
                        </select>
                    </div>
                }

                break;
            default:
                break;
        }
        <br/>
        <br/>
        <InputFile OnChange="e => OnImageSelected(question, e)" />
        @if (!string.IsNullOrEmpty(question.ImagePath))
        {
            <img src="@question.ImagePath" alt="Preview" style="max-width:200px;display:block;margin-top:.5em" />
        }
        <button @onclick="() => RemoveQuestion(question)">Remove Question</button>
        <button @onclick="() => CopyQuestion(question)">Copy Question</button>
        <hr />
    </div>
}

<button @onclick="AddQuestion">Add Question</button> <button @onclick="() => PasteQuestion()">Paste Question</button>
<button @onclick="SaveQuiz">Save Quiz</button>
<button @onclick="Cancel">Cancel</button>
<button @onclick="Bello">Do the Bello!</button>

@code {
    private string quizTitle = "";
    private List<Question> questions = new();
    private QuestionType selectedQuestionType = QuestionType.SingleChoice;
    private Question questionToCopy = null;

    // [Inject] private IWebHostEnvironment Env { get; set; }


    private void Bello()
    {
        Console.WriteLine("I'm doing the bello!!");
    }

    private void AddQuestion()
    {
        switch (selectedQuestionType)
        {
            case QuestionType.SingleChoice:
                var newSingleChoiceQuestion = new SingleChoiceQuestion
                    {
                        AnswerOptions = new List<AnswerOption>
                {
                    new AnswerOption { OptionText = "" },
                    new AnswerOption { OptionText = "" }
                },
                        CorrectAnswer = "0"
                    };
                questions.Add(newSingleChoiceQuestion);
                break;

            case QuestionType.MultipleChoice:
                var newMultipleChoiceQuestion = new MultipleChoiceQuestion
                    {
                        AnswerOptions = new List<AnswerOption>
                {
                    new AnswerOption { OptionText = "" },
                    new AnswerOption { OptionText = "" }
                },
                        CorrectAnswer = ""
                    };
                questions.Add(newMultipleChoiceQuestion);
                break;
            case QuestionType.TrueFalse:
                var newTrueFalseQuestion = new TrueFalseQuestion
                    {
                        AnswerOptions = new List<AnswerOption>
                {
                    new AnswerOption { OptionText = "True" },
                    new AnswerOption { OptionText = "False" }
                },
                        CorrectAnswer = "1"
                    };
                questions.Add(newTrueFalseQuestion);
                break;

            case QuestionType.TextInput:
                var newTextInputQuestion = new TextInputQuestion
                    {
                        CorrectAnswer = "",
                    };
                questions.Add(newTextInputQuestion);
                break;

            case QuestionType.Pairing:
                var newPairingQuestion = new PairingQuestion{CorrectAnswer = ""};
                newPairingQuestion.ColumnA = new List<string> { "", "" };
                newPairingQuestion.ColumnB = new List<string> { "", "" };
                newPairingQuestion.SyncAnswerOptionsFromColumns();
                questions.Add(newPairingQuestion);
                break;

            default: 
                break;
        }
        Console.WriteLine("^q^\n");
    }

    void AddPairRow(PairingQuestion pq)
    {
        // add one more A and one more B
        pq.ColumnA.Add("");
        pq.ColumnB.Add("");
        pq.SyncAnswerOptionsFromColumns();
    }

    void RemovePairRow(PairingQuestion pq)
    {
        // remove the last two
        if (pq.ColumnA.Count > 2)
        {
            pq.ColumnA.RemoveAt(pq.ColumnA.Count - 1);
            pq.ColumnB.RemoveAt(pq.ColumnB.Count - 1);
        }
        pq.SyncAnswerOptionsFromColumns();
    }


    private void RemoveQuestion(Question question)
    {
        questions.Remove(question);
    }

    private void CopyQuestion(Question question)
    {
        questionToCopy = question.Copy();
    }

    private void PasteQuestion()
    {
        if(questionToCopy != null) {
            var newQuestion = questionToCopy.Copy();
            questions.Add(newQuestion);
        }
    }

    private void AddOption(Question question)
    {
        // Only allow dynamic options for SingleChoice and MultipleChoice
        if (question is SingleChoiceQuestion || question is MultipleChoiceQuestion)
            question.AnswerOptions.Add(new AnswerOption { OptionText = "" });
    }

    private void RemoveOption(Question question)
    {
        if ((question is SingleChoiceQuestion || question is MultipleChoiceQuestion) && question.AnswerOptions.Count > 2)
            question.AnswerOptions.RemoveAt(question.AnswerOptions.Count - 1);
    }

    void OnCorrectOptionChange(MultipleChoiceQuestion mcq, int idx, ChangeEventArgs e)
    {
        var isChecked = e.Value?.ToString()?.ToLower() == "true";
        if (isChecked)
        {
            if (!mcq.CorrectAnswerIndices.Contains(idx))
                mcq.CorrectAnswerIndices.Add(idx);
        }
        else
        {
            mcq.CorrectAnswerIndices.Remove(idx);
        }
    }

    void OnPairSelectionChanged(PairingQuestion pq, int aIndex, int bIndex)
    {
        // assign or re‑assign the correct B for this A
        pq.CorrectPairs[aIndex] = bIndex;
    }



    private async Task SaveQuiz()
    {
        foreach (var mcq in questions.OfType<MultipleChoiceQuestion>())
        {
            // turn [0,2,3] into "0;2;3"
            mcq.CorrectAnswer = string.Join(";", mcq.CorrectAnswerIndices.OrderBy(x => x));
        }

        foreach (var pq in questions.OfType<PairingQuestion>())
        {
            pq.SyncAnswerOptionsFromColumns();
            pq.SyncCorrectAnswerFromPairs();
        }
        if (!string.IsNullOrWhiteSpace(quizTitle) && questions.Count > 0)
        {
            var newQuiz = new Quiz { Title = quizTitle, Questions = questions };
            await QuizService.AddQuizAsync(newQuiz);
            Navigation.NavigateTo("/");
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/quizzes");
    }

    async Task OnImageSelected(Question question, InputFileChangeEventArgs e)
    {
        var file = e.File;
        // generate a unique name
        var ext = Path.GetExtension(file.Name);
        var fileName = $"{Guid.NewGuid()}{ext}";
        var saveDir = Path.Combine(Env.WebRootPath, "uploads");
        Directory.CreateDirectory(saveDir);
        var savePath = Path.Combine(saveDir, fileName);

        // actually copy
        await using var fs = File.OpenWrite(savePath);
        await file.OpenReadStream(maxAllowedSize: 10_000_000).CopyToAsync(fs);

        // save the *relative* path back into your model
        question.ImagePath = $"uploads/{fileName}";
    }


    [Inject] private NavigationManager Navigation { get; set; }
}
